<!DOCTYPE html>
<html>

<head>
    <title>Stage Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box; /* This ensures padding does not affect the overall width */
}
        img {
            max-width: 100%;
            height: auto;
        }

        .chart-container {
            width: 100%;
            /* Use percentage rather than pixels */
        }

        @media only screen and (max-width: 600px) {
            .container {
                padding: 10px;
            }

            select,
            input,
            button {
                margin: 5px 0;
            }

            /* Adjust table styles for mobile */
            table,
            th,
            td {
                font-size: 0.8em;
                /* Smaller font size on mobile */
            }

            /* Additional mobile styles */
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding-top: 50px; /* Adjust as needed */
        }

        .container {
    width: 100%; /* Set width to 100% of the parent */
    max-width: 600px; /* Maximum width can be 600px or any value you prefer */
    margin: 0 auto; /* This will center the container */
    padding: 20px; /* Adjust padding as necessary */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center; /* Centers the text inside the container */
}

        select,
        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .process-container {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
        }
    </style>
    <!-- <link rel="stylesheet" type="text/css" href="styles.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <h1>Most Calculator</h1>

        <label for="stage">Select Stage:</label>
        <select id="stage">
            <option value="" disabled selected>Please select the stage</option>
            <option value="1">Stage 1</option>
            <option value="2">Stage 2</option>
            <option value="3">Stage 3</option>
            <option value="4">Stage 4</option>
        </select>

        <div id="process-container" class="process-container">
            <label for="processCount">How many processes do you want to calculate?</label>
            <input type="number" id="processCount" min="1" value="1">
        </div>

        <div id="process-type-container" class="process-container">
            <p>Choose the type for each process:</p>
            <div id="processTypes"></div>
        </div>

        <p id="totalSum"></p>
        <table id="totalsTable">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Total Sum</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Stage 1</td>
                    <td id="totalForStage1">0</td>
                </tr>
                <tr>
                    <td>Stage 2</td>
                    <td id="totalForStage2">0</td>
                </tr>
                <tr>
                    <td>Stage 3</td>
                    <td id="totalForStage3">0</td>
                </tr>
                <tr>
                    <td>Stage 4</td>
                    <td id="totalForStage4">0</td>
                </tr>
            </tbody>
        </table>

        <button id="resetButton">Reset</button>
        <div class="chart-container" style="position: relative; height:40vh; width:80vw">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        const stageSelect = document.getElementById('stage');
        const processContainer = document.getElementById('process-container');
        const processTypeContainer = document.getElementById('process-type-container');
        const processCountInput = document.getElementById('processCount');
        const processTypesContainer = document.getElementById('processTypes');


        function updateTotal(stage) {
            const results = Array.from(document.querySelectorAll('.result'));
            let totalSum = results.reduce((acc, result) => acc + parseFloat(result.textContent), 0);
            localStorage.setItem(`totalForStage${stage}`, totalSum);

            // Update table cell for the specific stage
            document.getElementById(`totalForStage${stage}`).textContent = totalSum;

            // If you want to also display the total sum in the previous <p> element, you can uncomment the line below
            document.getElementById('totalSum').textContent = `Total Sum for Stage ${stage}: ${totalSum}`;
        }

        stageSelect.addEventListener('change', () => {
            const stage = stageSelect.value;
            if (stage !== "") { // Check if a valid stage is selected
                processContainer.style.display = 'block';
                processCountInput.value = '0'; // Reset process count input
                processTypesContainer.innerHTML = ''; // Clear previous process types
            } else {
                processContainer.style.display = 'none'; // Hide if no valid stage is selected
                processTypeContainer.style.display = 'none';
            }
        });

        processCountInput.addEventListener('change', () => {
            const processCount = parseInt(processCountInput.value, 10);
            processTypesContainer.innerHTML = '';

            if (processCount > 0) {
                for (let i = 0; i < processCount; i++) {
                    const processDiv = document.createElement('div');
                    processDiv.style.display = 'flex';
                    processDiv.style.alignItems = 'center';
                    processDiv.style.justifyContent = 'space-between';

                    const processTypeSelect = document.createElement('select');
                    processTypeSelect.name = `processType${i}`;
                    processTypeSelect.id = `processType${i}`;
                    processTypeSelect.innerHTML = `
        <option value="control_move">Control Move</option>
        <option value="general_move">General Move</option>
        <option value="tool_use">Tool Use</option>
        `;

                    const processButton = document.createElement('button');
                    processButton.textContent = 'Calculate';
                    processButton.style.marginLeft = '10px';

                    const resultSpan = document.createElement('span');
                    resultSpan.className = 'result';
                    resultSpan.id = `resultSpan${i}`;
                    resultSpan.style.marginLeft = '10px';

                    processButton.addEventListener('click', () => {
                        const processType = processTypeSelect.value;
                        localStorage.setItem('currentProcessIndex', i);
                        localStorage.setItem('currentStage', stageSelect.value);

                        switch (processType) {
                            case 'control_move':
                                window.location.href = 'control-move.html';
                                break;
                            case 'general_move':
                                window.location.href = 'general-move.html';
                                break;
                            case 'tool_use':
                                window.location.href = 'tool-use.html';
                                break;
                        }

                        saveCurrentState();
                    });

                    resultSpan.textContent = localStorage.getItem(`result${stageSelect.value}_${i}`) || 0;
                    processDiv.appendChild(processTypeSelect);
                    processDiv.appendChild(processButton);
                    processDiv.appendChild(resultSpan);
                    processTypesContainer.appendChild(processDiv);
                }
                processTypeContainer.style.display = 'block';
                updateTotal(stageSelect.value);
            } else {
                processTypeContainer.style.display = 'none';
            }

            refreshResults();

        });

        function initializeTableValues() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`totalForStage${i}`).textContent = localStorage.getItem(`totalForStage${i}`) || 0;
            }
        }
        initializeTableValues();

        function resetValues() {
            // Reset totals for each stage
            for (let i = 1; i <= 4; i++) {
                localStorage.setItem(`totalForStage${i}`, 0);
                document.getElementById(`totalForStage${i}`).textContent = '0';
            }

            // Reset other values in local storage
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('totalForStage') || key.startsWith('result')) {
                    localStorage.setItem(key, 0);
                }
            });

            // Reset UI components if needed
            // For example, reset process count, process types, etc.
            processCountInput.value = '0';
            processTypesContainer.innerHTML = '';
            processTypeContainer.style.display = 'none';

            generateBarChart();
        }

        function refreshResults() {
            let stage = stageSelect.value;
            // let stage = localStorage.getItem('currentStages');
            let processCount = parseInt(processCountInput.value, 10);

            for (let i = 0; i < processCount; i++) {
                let result = localStorage.getItem(`result${stage}_${i}`) || 0;
                let resultSpan = document.getElementById(`resultSpan${i}`);
                if (resultSpan) {
                    resultSpan.textContent = result;
                }
            }

            updateTotal(stage);
        }

        function saveCurrentState() {
            // Save the current stage and process count
            localStorage.setItem('currentStage', stageSelect.value);
            localStorage.setItem('processCount', processCountInput.value);

            // Save the state for each process
            for (let i = 0; i < parseInt(processCountInput.value, 10); i++) {
                const processTypeSelect = document.getElementById(`processType${i}`);
                localStorage.setItem(`processType${i}`, processTypeSelect.value);
            }
        }

        function restoreState() {
            const savedStage = localStorage.getItem('currentStage');
            const savedProcessCount = localStorage.getItem('processCount');

            if (savedStage) {
                stageSelect.value = savedStage;
                processContainer.style.display = 'block';
            }

            if (savedProcessCount) {
                processCountInput.value = savedProcessCount;
                processCountInput.dispatchEvent(new Event('change')); // Trigger change event

                for (let i = 0; i < parseInt(savedProcessCount, 10); i++) {
                    const processTypeSelect = document.getElementById(`processType${i}`);
                    processTypeSelect.value = localStorage.getItem(`processType${i}`);
                }
            }
        }

        function generateBarChart() {
            const { labels, data } = extractDataFromTable();

            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sum',
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.5)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }


        function extractDataFromTable() {
            // Arrays to hold the labels (stage names) and data (total sums)
            let labels = [];
            let data = [];

            // Select all rows in the tbody of the table
            const tableRows = document.querySelectorAll('#totalsTable tbody tr');

            // Loop through each row
            tableRows.forEach(row => {
                // The first cell (td) contains the stage name
                const stageName = row.cells[0].innerText;
                labels.push(stageName);

                // The second cell (td) contains the total sum
                const totalSum = row.cells[1].innerText;
                data.push(parseFloat(totalSum)); // Convert the total sum to a number
            });

            // Return the extracted data
            return { labels, data };
        }

        window.onload = function () {


            restoreState();
            initializeTableValues();
            refreshResults();
            generateBarChart();
        }

        document.getElementById('resetButton').addEventListener('click', resetValues);

    </script>
</body>

</html>